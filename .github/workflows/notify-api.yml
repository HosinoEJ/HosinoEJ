name: Post File Changes to API

on:
  push:
    branches:
      - main
    # 這個路徑下的檔案變動時，觸發 Workflow
    paths:
      - 'public/prot/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files in public/prot
        id: files
        run: |
          # 這裡加上了路徑過濾 "public/prot/"
          # tr '\n' ',' 是將換行轉為逗號，方便 API 處理
          ADDED=$(git diff --name-only --diff-filter=A HEAD^ HEAD -- "public/prot/" | tr '\n' ',' | sed 's/,$//')
          MODIFIED=$(git diff --name-only --diff-filter=M HEAD^ HEAD -- "public/prot/" | tr '\n' ',' | sed 's/,$//')
          
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT

      - name: Send POST request to API
        if: steps.files.outputs.added != '' || steps.files.outputs.modified != ''
        run: |
          # 使用 jq 構建安全的 JSON
          payload=$(jq -n \
            --arg project "${{ github.repository }}" \
            --arg commit "${{ github.sha }}" \
            --arg added "${{ steps.files.outputs.added }}" \
            --arg modified "${{ steps.files.outputs.modified }}" \
            '{project: $project, commit_id: $commit, added_files: $added, modified_files: $modified}')

          curl -X POST "https://your-website.com/api/webhook" \
          -H "Content-Type: application/json" \
          -d "$payload"